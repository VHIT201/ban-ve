{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport type { NextRequest } from \"next/server\";\r\n\r\ninterface SessionPayload {\r\n  userId: string;\r\n  email: string;\r\n  username: string;\r\n  role: \"user\" | \"admin\" | \"collaborator\";\r\n  exp: number;\r\n}\r\n\r\n/**\r\n * Decode JWT token (without verification)\r\n * In production, consider using jose library for proper verification\r\n */\r\nfunction decodeToken(token: string): SessionPayload | null {\r\n  try {\r\n    const base64Url = token.split(\".\")[1];\r\n    if (!base64Url) return null;\r\n\r\n    const base64 = base64Url.replace(/-/g, \"+\").replace(/_/g, \"/\");\r\n    const jsonPayload = decodeURIComponent(\r\n      atob(base64)\r\n        .split(\"\")\r\n        .map((c) => \"%\" + (\"00\" + c.charCodeAt(0).toString(16)).slice(-2))\r\n        .join(\"\"),\r\n    );\r\n\r\n    const payload = JSON.parse(jsonPayload) as SessionPayload;\r\n\r\n    // Check if token is expired\r\n    if (payload.exp && payload.exp * 1000 < Date.now()) {\r\n      return null;\r\n    }\r\n\r\n    return payload;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  const { pathname } = request.nextUrl;\r\n\r\n  // Get tokens from cookies\r\n  const accessToken = request.cookies.get(\"accessToken\")?.value;\r\n  const refreshToken = request.cookies.get(\"refreshToken\")?.value;\r\n\r\n  // Decode session\r\n  const session = accessToken ? decodeToken(accessToken) : null;\r\n\r\n  // Define route types\r\n  const isPublicRoute =\r\n    pathname === \"/\" ||\r\n    pathname.startsWith(\"/detail\") ||\r\n    pathname.startsWith(\"/collections\") ||\r\n    pathname.startsWith(\"/search\") ||\r\n    pathname.startsWith(\"/terms\") ||\r\n    pathname.startsWith(\"/privacy\") ||\r\n    pathname.startsWith(\"/contact\") ||\r\n    pathname.startsWith(\"/cookie-policy\") ||\r\n    pathname.startsWith(\"/_next\") ||\r\n    pathname.startsWith(\"/api\") ||\r\n    pathname.startsWith(\"/static\");\r\n\r\n  const isAuthRoute = pathname.startsWith(\"/auth\");\r\n\r\n  const isProtectedRoute =\r\n    pathname.startsWith(\"/profile\") ||\r\n    pathname.startsWith(\"/downloads\") ||\r\n    pathname.startsWith(\"/payment\") ||\r\n    pathname.startsWith(\"/setting\");\r\n\r\n  const isAdminRoute = pathname.startsWith(\"/admin\");\r\n\r\n  // Allow public routes\r\n  if (isPublicRoute && !isAuthRoute) {\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Handle auth routes (login, register, etc.)\r\n  if (isAuthRoute) {\r\n    // If user is already authenticated, redirect to home\r\n    if (session) {\r\n      return NextResponse.redirect(new URL(\"/\", request.url));\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Handle protected routes\r\n  if (isProtectedRoute) {\r\n    if (!session) {\r\n      // Save the original URL to redirect back after login\r\n      const redirectUrl = new URL(\"/auth/login\", request.url);\r\n      redirectUrl.searchParams.set(\"redirect\", pathname);\r\n      return NextResponse.redirect(redirectUrl);\r\n    }\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Handle admin routes\r\n  if (isAdminRoute) {\r\n    if (!session) {\r\n      const redirectUrl = new URL(\"/auth/login\", request.url);\r\n      redirectUrl.searchParams.set(\"redirect\", pathname);\r\n      return NextResponse.redirect(redirectUrl);\r\n    }\r\n\r\n    // Check admin role\r\n    if (session.role !== \"admin\") {\r\n      return NextResponse.redirect(new URL(\"/\", request.url));\r\n    }\r\n\r\n    return NextResponse.next();\r\n  }\r\n\r\n  // Token refresh logic (if access token expired but refresh token exists)\r\n  if (!session && refreshToken) {\r\n    try {\r\n      const response = await fetch(\r\n        `${process.env.NEXT_PUBLIC_API_BASE_URL}/auth/refresh`,\r\n        {\r\n          method: \"POST\",\r\n          headers: {\r\n            \"Content-Type\": \"application/json\",\r\n          },\r\n          body: JSON.stringify({ refreshToken }),\r\n        },\r\n      );\r\n\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        const newAccessToken = data.data.accessToken;\r\n\r\n        // Create response with new cookie\r\n        const nextResponse = NextResponse.next();\r\n\r\n        nextResponse.cookies.set(\"accessToken\", newAccessToken, {\r\n          httpOnly: true,\r\n          secure: process.env.NODE_ENV === \"production\",\r\n          sameSite: \"lax\",\r\n          maxAge: 60 * 60 * 24 * 7, // 7 days\r\n          path: \"/\",\r\n        });\r\n\r\n        return nextResponse;\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Token refresh failed:\", error);\r\n    }\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all request paths except:\r\n     * - _next/static (static files)\r\n     * - _next/image (image optimization files)\r\n     * - favicon.ico (favicon file)\r\n     * - public folder files\r\n     */\r\n    \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp|ico|woff|woff2|ttf|eot)$).*)\",\r\n  ],\r\n};\r\n"],"names":[],"mappings":"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"}}]
}